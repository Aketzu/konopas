function Server(e,t,r){this.id=e,this.stars=t,r=r||{},this.host=r.host||"https://konopas-server.appspot.com",this.el_id=r.el_id||"server_connect",this.err_el_id=r.err_el_id||"server_error",this.connected=!1,this.ical=localStorage.getItem("konopas."+this.id+".ical_link")||!1,this.prog_data={},this.prog_server_mtime=0,this.my_votes_data={},this.my_votes_mtime=0,this.vote_timers={},this.pub_data={},this.pub_comments={},this.el=document.getElementById(this.el_id),this.err_el=!1,this.disconnect(),this.stars&&(this.stars.server=this),this.el&&this.id?this.exec("info"):_log("server init failed","warn");var n=/#server_error=(.+)/.exec(window.location.hash);n&&this.error(decodeURIComponent(n[1].replace(/\+/g," ")),window.location.href,this)}function Stars(e,t){this.name="konopas."+e+".stars",t=t||{},this.store=t.store||localStorage,this.tag=t.tag||"has_star",this.server=!1,this.data=this.read()}function link_to_short_url(e){return"http://is.gd/create.php?url="+encodeURIComponent(e.replace(/^http:\/\//,""))}function link_to_qr_code(e){return"http://chart.apis.google.com/chart?cht=qr&chs=350x350&chl="+encodeURIComponent(e.replace(/^http:\/\//,""))}function _log(e,t){if(ko.log_messages&&console)switch(t){case"error":console.error(e);break;case"warn":console.warn(e);break;default:console.log(e)}}function EL(e){return document.getElementById(e)}function _new_elem(e,t,r,n){var i=document.createElement(e);return t&&(i.className=t),r&&(i.textContent=r),n&&(i.style.display="none"),i}function _set_class(e,t,r){e.classList[r?"add":"remove"](t)}function selected_id(e){var t=EL(e);if(!t)return"";var r=t.getElementsByClassName("selected");return r.length?r[0].id:""}function make_popup_menu(e,t){if(e&&1==e.nodeType||(e=EL(e))){t&&1==t.nodeType||(t&&(t=EL(t)),t||(t=_new_elem("div","popup-bg"),e.appendChild(t))),e.onclick=function(){if(e.classList.contains("show_box")){t.style.display="none",e.classList.remove("show_box");var r=parseInt(getComputedStyle(e.parentNode)["z-index"]||"2");e.parentNode.style.zIndex=r-1}else{t.style.display="block",e.classList.add("show_box");var r=parseInt(getComputedStyle(e.parentNode)["z-index"]||"1");e.parentNode.style.zIndex=r+1}};var r=e.getElementsByClassName("popup-title");r.length&&r[0].setAttribute("data-title",r[0].textContent)}}function popup_boxify(e){for(var t=e.getElementsByTagName("a"),r=t.length-1;r>=0;--r)if(/\.(gif|jpe?g|png)$/i.test(t[r].href)){var n=_new_elem("div","popup-wrap");n.innerHTML="<span>"+t[r].textContent+'</span><img class="popup" src="'+t[r].href+'">',t[r].parentNode.replaceChild(n,t[r]),make_popup_menu(n)}}function pre0(e){return(10>e?"0":"")+e}function string_date(e){return e||(e=new Date),e.getFullYear()+"-"+pre0(e.getMonth()+1)+"-"+pre0(e.getDate())}function string_time(e){return e||(e=new Date),pre0(e.getHours())+":"+pre0(e.getMinutes())}function weekday(e,t){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][t?e.getUTCDay():e.getDay()]}function _pretty_time(e,t){if(ko.time_show_am_pm){var r=e%12;0==r&&(r=12);var n=0==t&&ko.abbrev_00_minutes?"":":"+pre0(t);return r+n+(12>e?"am":"pm")}return pre0(e)+":"+pre0(t)}function pretty_time(e,t){if(e instanceof Date)return t?_pretty_time(e.getUTCHours(),e.getUTCMinutes()):_pretty_time(e.getHours(),e.getMinutes());if("string"==typeof e||e instanceof String){if(ko.time_show_am_pm){var r=e.split(":");return _pretty_time(parseInt(r[0],10),parseInt(r[1],10))}return e}return""}function pretty_time_diff(e){var t=(Date.now()-e)/1e3,r=["seconds","minutes","hours","days","weeks","months","years"],n=[1,60,60,24,7,4.333,12,1e9],i=0>t?" from now":" ago";if(t=Math.abs(t),20>t)return"just now";for(var a=0,o=n.length;o>a;++a)if((t/=n[a])<2)return~~(t*=n[a])+" "+r[a-1]+i}function pretty_date(e){var t=weekday(e,!0),r=e-Date.now();return(0>r||r>5184e5)&&(t+=", "+e.getUTCDate()+" "+["January","February","March","April","May","June","July","August","September","October","November","December"][e.getUTCMonth()],Math.abs(r)>5184e6&&(t+=" "+e.getUTCFullYear())),t}function time_sum(e,t){var r=60*e.substr(0,2)+1*e.substr(3,2)+1*t,n=r/60>>0,i=r-60*n;return pre0(n%24)+":"+pre0(i)}function storage_get(e){var t=sessionStorage.getItem("konopas."+ko.id+"."+e);return t?JSON.parse(t):t}function storage_set(e,t){try{sessionStorage.setItem("konopas."+ko.id+"."+e,JSON.stringify(t))}catch(r){if(r.code!==DOMException.QUOTA_EXCEEDED_ERR||0!==sessionStorage.length)throw r;private_browsing_noted||(alert("It looks like you're using an iOS or Safari browser in private mode, which disables localStorage. This will result in a suboptimal KonOpas experience."),private_browsing_noted=!0)}}function GlobToRE(e){var t=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\/-]","g");e=e.replace(t,"\\$&").replace(/\\\*/g,".*").replace(/\\\?/g,".");var r=e.match(/"[^"]*"|'[^']*'|\S+/g).map(function(e){var t="\\b"+e.replace(/^(['"])(.*)\1$/,"$2")+"\\b";return t});return new RegExp(r.join("|"),"i")}function set_view(e){document.body.className=e,storage_set("view",e)}function clean_name(e,t){var r="",n="";switch(e.name.length){case 1:n=e.name[0];break;case 2:e.name[1]?(r=e.name[0],n=e.name[1]):n=e.name[0];break;case 3:r=e.name[2]+" "+e.name[0],n=e.name[1];break;case 4:r=e.name[2]+" "+e.name[0],n=e.name[1]+", "+e.name[3]}return t?'<span class="fn">'+r.trim()+'</span> <span class="ln">'+n.trim()+"</span>":(r+" "+n).trim()}function clean_links(e){var t=!1,r={};if("links"in e){if("img"in e.links&&e.links.img){var n=e.links.img.trim();/^www/.exec(n)&&(n="http://"+n),/:\/\//.exec(n)&&(r.img=n,t=!0)}if("url"in e.links&&e.links.url){var i=e.links.url.trim();/:\/\//.exec(i)||(i="http://"+i),r.url=i,t=!0}if("fb"in e.links&&e.links.fb){var a=e.links.fb.trim();a=a.replace(/^(https?:\/\/)?(www\.)?facebook.com(\/#!)?\//,""),/[^a-zA-Z0-9.]/.exec(a)&&!/^pages\//.exec(a)&&(a="search.php?q="+encodeURI(a).replace(/%20/g,"+")),r.fb=a,t=!0}if("twitter"in e.links&&e.links.twitter){var o=e.links.twitter.trim();o=o.replace(/[@＠﹫]/g,"").replace(/^(https?:\/\/)?(www\.)?twitter.com(\/#!)?\//,""),/[^a-zA-Z0-9_]/.exec(o)&&(o="search/users?q="+encodeURI(o).replace(/%20/g,"+")),r.twitter=o,t=!0}}return t?r:!1}function arrays_equal(e,t){if(!e||!t)return!1;var r=e.length;if(r!=t.length)return!1;for(var n=0;r>n;++n)if(e[n]!=t[n])return!1;return!0}function array_overlap(e,t){if(!e||!t)return 0;var r=e.length,n=t.length;if(r>n)return array_overlap(t,e);for(var i=0,a=0;r>a;++a)for(var o=0;n>o;++o)if(e[a]==t[o]){++i;break}return i}function _item_people(e){if(!e.people||!e.people.length)return"";var t=e.people.map(function(e){return'<a href="#part/'+encodeURIComponent(e.id)+'">'+e.name+"</a>"});return'<div class="item-people">'+t.join(", ")+"</div>\n"}function _item_tags(e){if(!e.tags||!e.tags.length)return"";var t=e.tags.map(function(e){return'<a href="#prog/tag:'+encodeURIComponent(e)+'">'+e+"</a>"});return'<div class="discreet">Tags: '+t.join(", ")+"</div>\n"}function _item_loc_str(e){var t="";return e.loc&&e.loc.length&&(t=e.loc[0],e.loc.length>1&&(t+=" ("+e.loc.slice(1).join(", ")+")")),e.mins&&e.mins!=ko.default_duration&&(t&&(t+=", "),t+=pretty_time(e.time)+" - "+pretty_time(time_sum(e.time,e.mins))),t}function _item_sort(e,t){if(e.date<t.date)return-1;if(e.date>t.date)return 1;if(e.time<t.time)return-1;if(e.time>t.time)return 1;if(e.loc.length<t.loc.length)return-1;if(e.loc.length>t.loc.length)return 1;for(var r=e.loc.length-1;r>=0;--r){if(e.loc[r]<t.loc[r])return-1;if(e.loc[r]>t.loc[r])return 1}return 0}function _item_show_extra(e,t){if(!EL("e"+t)){var r="",n=program.filter(function(e){return e.id==t});n.length<1?r="Program id <b>"+t+"</b> not found!":(r=_item_tags(n[0])+_item_people(n[0]),n[0].desc&&(r+="<p>"+n[0].desc));var i=_new_elem("div","extra");i.id="e"+t,i.innerHTML=r,e.appendChild(i),server&&server.show_extras(t,e)}}function item_show_list(e){var t=document.createDocumentFragment(),r="",n="",i="";e.length>0&&e.length<ko.expand_all_max_items&&(t.appendChild(_new_elem("div","item_expander","» ")).appendChild(_new_elem("a","js-link","Expand all")).id="item_expander_link");for(var a=0,o=e.length;o>a;++a){if(e[a].date!=r){if(e[a].date<r)return item_show_list(e.sort(_item_sort)),void 0;r=e[a].date,i="";var s=new Date(e[a].date);n=pretty_date(s),t.appendChild(_new_elem("div","new_day",n))}if(e[a].time!=i){if(e[a].time<i)return item_show_list(e.sort(_item_sort)),void 0;i=e[a].time,t.appendChild(document.createElement("hr")),t.appendChild(_new_elem("div","new_time",pretty_time(e[a].time))).setAttribute("data-day",n.substr(0,3))}t.appendChild(_item_el(e[a]))}for(var l=EL("prog_ls");l.firstChild;)l.removeChild(l.firstChild);l.appendChild(t),server&&server.decorate_list(l);var c=EL("item_expander_link");c&&(c.onclick=function(){{var e=l.getElementsByClassName("item");"Expand all"==c.textContent}if("Expand all"==c.textContent){for(var t=0,r=e.length;r>t;++t)e[t].parentNode.classList.add("expanded"),_item_show_extra(e[t],e[t].id.substr(1));c.textContent="Collapse all"}else{for(var t=0,r=e.length;r>t;++t)e[t].parentNode.classList.remove("expanded");c.textContent="Expand all"}});for(var d=l.getElementsByClassName("item_star"),a=0,o=d.length;o>a;++a)d[a].onclick=function(){return stars.toggle(this,this.id.substr(1)),!1};for(var p=stars.list(),a=0,o=p.length;o>a;++a){var _=EL("s"+p[a]);_&&_.classList.add("has_star")}}function item_list_click(e){e=e||window.event;for(var t=e.target;!/\bitem(_|$)/.test(t.className);){if("prog_ls"==t.id)return;if("a"==t.tagName.toLowerCase()&&t.href)return;t=t.parentNode}t.id&&"p"==t.id[0]&&t.parentNode.classList.toggle("expanded")&&_item_show_extra(t,t.id.substr(1))}function update_next_select(e){var t=EL("next_time_select");if(t){var r=30,n=[-12*r,12*r],i=new Date;i.setMinutes(15*Math.floor(i.getMinutes()/15)+n[0]),t.options.length=0;for(var a=n[0];a<=n[1];a+=r){var o=document.createElement("option");o.value=a,o.text=weekday(i,!1)+", "+pretty_time(i,!1),a==e&&(o.selected=!0),a||(o.id="next_time_select_now"),t.add(o),i.setMinutes(i.getMinutes()+r)}t.onchange=function(){update_next_list(selected_id("next_type"))};var s=EL("next_earlier");s&&(s.onclick=function(){t.selectedIndex=Math.max(t.selectedIndex-1,0),t.onchange()});var l=EL("next_later");l&&(l.onclick=function(){t.selectedIndex=Math.min(t.selectedIndex+1,t.length-1),t.onchange()})}}function update_next_list(e){var t=EL("next_time_select"),r=t.selectedIndex>=0?parseInt(t[t.selectedIndex].value):0;r||(r=0),update_next_select(r);var n=new Date;n.setMinutes(15*Math.floor(n.getMinutes()/15)+r);var i=string_date(n),a=string_time(n);n.setMinutes(n.getMinutes()-n.getTimezoneOffset());for(var o={},s=0,l=n.valueOf()+36e5,c=0,d=0,p=program.length;p>d;++d){var _=program[d];if(!(_.date<i||_.date==i&&_.time<a)){var u=Date.parse(_.date+"T"+_.time);if((!s||s>u)&&u>l&&(s=u),"next_by_room"==e){if(_.loc){if(o[_.loc[0]]){if(o[_.loc[0]].date<_.date)continue;if(o[_.loc[0]].date==_.date&&o[_.loc[0]].time<_.loc[0])continue}o[_.loc[0]]=_}}else l>=u&&(o["n"+ ++c]=_)}}var m=[];for(var f in o)m.push(o[f]);if(m.length>0)EL("next_start_note").textContent="";else if(s){var h="",v=new Date;v.setMinutes(v.getMinutes()+r-v.getTimezoneOffset());var g=Math.floor((s-v)/6e4),y=Math.floor(g/60);y>=1&&(g-=60*y,h+=y+" hour"+(1==y?"":"s")+" and "),h+=g+" minute"+(1==g?"":"s"),EL("next_start_note").textContent="The next program item starts in "+h+" after the set time."}else EL("next_start_note").textContent="There are no more program items scheduled.";item_show_list(m)}function update_next_filters(e){"next_by_room"!=e&&(e="next_by_hour");for(var t=EL("next_type").getElementsByTagName("li"),r=0,n=t.length;n>r;++r)_set_class(t[r],"selected",t[r].id==e);storage_set("next",{next_type:e})}function next_filter(e,t){var r=selected_id("next_type");switch(e){case"next_type":r=t}update_next_list(r),update_next_filters(r)}function show_next_view(){set_view("next");var e="next_by_hour",t=storage_get("next")||{};"next_type"in t&&(e=t.next_type),update_next_list(e),update_next_filters(e)}function show_star_view(e){set_view("star");var t=EL("star_data"),r=e&&"set:"==e.substr(1,4)?e.substr(5).split(","):[],n=program.filter(function(e){return r.indexOf(e.id)>=0}).map(function(e){return e.id});n.sort();var i=n.length,a=stars.list();a.sort();var o=a.length;if(o||i){var s='<a href="#star/set:'+a.join(",")+'">';if(i)if(arrays_equal(n,a))t.innerHTML="<p>Your current selection is encoded in "+s+"this page's URL</a>, which you may open elsewhere to share your selection.<p>For easier sharing, you can also generate a <a href=\""+link_to_short_url(location.href)+'">shorter link</a> or a <a href="'+link_to_qr_code(location.href)+'">QR code</a>.',server&&server.show_ical_link(t);else{var l=array_overlap(n,a),c=i-l,d='<p>Your previously selected items are shown with a highlighted interior, while those imported via <a href="'+location.href+'">this link</a> have a highlighted border.';switch(d+="\n<p>Your previous selection ",o){case 0:d+="was empty";break;case 1:d+="had 1 item";break;default:d+="had "+o+" items"}switch(d+=", and the imported selection has ",c){case 0:d+="no new items";break;case 1:d+="1 new item";break;default:d+=c+" new items"}switch(l){case 0:d+=".";break;case o:d+=".";break;case 1:d+=" and 1 which was already selected.";break;default:d+=" and "+l+" which were already selected."}if(i!=r.length){var p=r.length-i;d+=" "+p+" of the imported items had "+(p>1?"invalid IDs.":"an invalid ID.")}if(o&&l==o||(d+='<p>&raquo; <a href="#star" id="star_set_set">Set my selection to the imported selection</a>'),o){if(l!=o){var _=[];c&&_.push("add "+c),_.push("discard "+(o-l)),d+=" ("+_.join(", ")+")"}c&&(d+='<p>&raquo; <a href="#star" id="star_set_add">Add the '+(c>1?c+" new items":"new item")+" to my selection</a>")}t.innerHTML=d;var u=EL("star_set_set");u&&(u.onclick=function(){return stars.set(n),!0});var m=EL("star_set_add");m&&(m.onclick=function(){return stars.add(n),!0})}else{var d="<p>&raquo; "+s+"Export selection</a>";switch(o){case 1:d+=" (1 item)";break;default:d+=" ("+o+" items)"}t.innerHTML=d}var f=program.filter(function(e){return a.indexOf(e.id)>=0||n.indexOf(e.id)>=0});if(item_show_list(f),i){document.body.classList.add("show_set");for(var h=0;i>h;++h){var v=EL("s"+n[h]);v&&v.classList.add("in_set")}}}else t.innerHTML='<p>To "star" a program item, click on the gray square next to it. Your selections will be remembered, and shown in this view. You currently don\'t have any program items selected, so this list is empty.',EL("prog_ls").innerHTML=""}function _prog_default_day(){var e="",t="",r=EL("day");if(!r)return"";var n=r.getElementsByTagName("li");if(!n||!n.length)return"";for(var i=0,a=n.length;a>i;++i){var o=n[i].id.substr(1);o&&"ll_days"!=o&&((!e||e>o)&&(e=o),(!t||o>t)&&(t=o))}var s=string_date(),l=s>e&&t>=s?s:e;return l}function _prog_get_filters(){var e={day:"",area:"",tag:"",query:""},t=window.location.toString().split("#")[1]||"",r=!1;if("prog"==t.substr(0,4))for(var n=t.substr(5).split("/"),i=0;i<n.length;++i){var a=n[i].split(":");2==a.length&&a[0]&&a[1]&&(e[a[0]]=decodeURIComponent(a[1]),r=!0)}if(!r&&!document.body.classList.contains("prog")){var o=storage_get("prog");if(o)for(var s in o)e.hasOwnProperty(s)&&(e[s]=o[s])}return e}function _prog_set_filters(e){storage_set("prog",e);var t=["prog"];for(var r in e)if(r&&e[r]){if("area"==r&&"all_areas"==e[r])continue;if("tag"==r&&"all_tags"==e[r])continue;t.push(r+":"+encodeURIComponent(e[r]))}var n=t.join("/"),i=window.location.toString().split("#")[1]||"";return i!=n?(window.location.hash="#"+n,!0):!1}function _prog_filter(e){if(this.day&&e.date!=this.day)return!1;if(this.area&&(!e.loc||e.loc.indexOf(this.area)<0))return!1;if(this.tag)if(this.tag instanceof RegExp){if(!this.tag.test(e.title))return!1}else if(!e.tags||e.tags.indexOf(this.tag)<0)return!1;if(this.query){var t=this.query.test(e.title)||this.query.test(e.desc)||e.loc&&this.query.test(e.loc[0]);if(!t&&e.people)for(var r=0;r<e.people.length;++r)if(this.query.test(e.people[r])){t=!0;break}if(!t)return!1}return!0}function _prog_show_list(e){var t=e.tag||"";if(e.tag&&EL(e.tag)){var r=EL(e.tag).getAttribute("data-regexp");r&&(e.tag=new RegExp(r))}var n=e.query||"";e.query&&(e.query=GlobToRE(e.query));var i=program.filter(_prog_filter,e);e.tag&&(e.tag=t),e.query&&(e.query=n);var a=EL("filter_sum");if(a){var o=!0,s="item";if(1!=i.length&&(s+="s"),e.tag&&(s="<b>"+e.tag+"</b> "+s,o=!1),e.day){var l=new Date(e.day);s+=" on <b>"+weekday(l,!0)+"</b>",o=!1}e.area&&(s+=" in <b>"+e.area+"</b>",o=!1),e.query&&(s+=" matching the query <b>"+e.query+"</b>",o=!1),a.innerHTML="Listing "+(o?"<b>all</b> ":"")+i.length+" "+s}item_show_list(i)}function _prog_show_filters(e){var t=EL("prog_filters").getElementsByClassName("selected");if(t)for(var r=t.length-1;r>=0;--r){var n=t[r].classList;n.contains("popup-title")&&(t[r].textContent=t[r].getAttribute("data-title")||"More..."),n.remove("selected")}for(var i in e)if("query"==i){var a=EL("q");a&&(a.value=e.query,e.query&&a.classList.add("selected"))}else{var o=e[i];o?o.match(/^[^a-zA-Z]/)&&(o=i[0]+o):o="all_"+i+"s";var s=EL(o);if(s&&(s.classList.add("selected"),s.parentNode.id.match(/\d+$/))){var l=s.parentNode.parentNode.firstChild;l.classList.add("selected"),l.textContent=s.textContent}}var c=EL("q_hint");if(c){if(e.query){var d=EL("q_hint_example");if(d){var p=e.query.match(/[?*"]/)?"":e.query+"*";p?(d.textContent=p,d.parentNode.onmouseup=function(){EL("q").value=p,EL("q").focus(),EL("q").blur()},d.parentNode.style.display="inline",d.parentNode.style.cursor="pointer"):d.parentNode.style.display="none"}}c.style.display=e.query?"block":"none"}}function show_prog_view(){set_view("prog");var e=_prog_get_filters();if(!_prog_set_filters(e)){e.day||ko.show_all_days_by_default||(e.day=_prog_default_day()),_prog_show_filters(e);for(var t in e)t&&e[t]&&e[t]!="all_"+t+"s"||delete e[t];_prog_show_list(e)}}function prog_filter_change(e){e=e||window.event;var t,r;switch(e.type){case"click":if("li"!=e.target.tagName.toLowerCase())return;switch(t=e.target.parentNode.id.replace(/\d+$/,""),r=e.target.id,t){case"day":r=r.replace(/^d/,"");break;case"area":r=r.replace(/^a([^a-zA-Z])/,"$1")}break;case"submit":e.preventDefault();case"blur":t="query",r=EL("q").value;break;default:return}var n=_prog_get_filters();n[t]=r,_prog_set_filters(n)&&e.stopPropagation()}function show_participant(e){var t=clean_name(e,!1),r="",n="",i=clean_links(e);if(i){r+='<dl class="linklist">';for(var a in i){var o=i[a];switch(a){case"url":r+='<dt>URL:<dd><a href="'+o+'">'+o+"</a>";break;case"twitter":r+='<dt>Twitter:<dd><a href="https://www.twitter.com/'+o+'">@'+o+"</a>";break;case"fb":r+='<dt>Facebook:<dd><a href="https://www.facebook.com/'+o+'">/'+o+"</a>";break;case"img":r+='<dt>Photo:<dd><a href="'+o+'">'+o+"</a>";break;default:r+="<dt>"+a+":<dd>"+o}}r+="</dl>"}EL("part_names").innerHTML="",EL("part_info").innerHTML='<h2 id="part_title">'+t+"</h2>"+(e.bio||n?"<p>"+n+e.bio:"")+r,item_show_list(program.filter(function(t){return e.prog.indexOf(t.id)>=0}))}function _name_in_range(e,t){switch(t.length){case 1:return e==t[0];case 2:return e>=t[0]&&e<=t[1];default:return t.indexOf(e)>=0}}function show_participant_list(e){var t=e?people.filter(function(t){var r=t.sortname[0].toUpperCase();return _name_in_range(r,e)}):people;EL("part_names").innerHTML=t.map(function(e){return'<li><a href="#part/'+encodeURIComponent(e.id)+'">'+clean_name(e,!0)+"</a></li>"}).join(""),EL("part_info").innerHTML="",EL("prog_ls").innerHTML=""}function update_part_view(e,t){var r=EL("name_range");if(r)for(var n=r.getElementsByTagName("li"),i=0,a=n.length;a>i;++i)_set_class(n[i],"selected",n[i].getAttribute("data-range")==e);var i,o=t.substr(1);for(i=0,a=people.length;a>i;++i)if(people[i].id==o){show_participant(people[i]);break}i==people.length&&(t="",show_participant_list(e)),storage_set("part",{name_range:e,participant:t})}function part_filter(e,t){var r="name_range"==e?t.getAttribute("data-range"):"";update_part_view(r,"")}function find_name_range(e){var t=e[0].toUpperCase();if(!t)return"";var r=EL("name_range");if(!r)return"";for(var n=r.getElementsByTagName("li"),i=0,a=n.length;a>i;++i){var o=n[i].getAttribute("data-range");if(o&&_name_in_range(t,o))return o}return""}function show_part_view(e){var t="",r="",n=storage_get("part")||{};if("name_range"in n&&(t=n.name_range),document.body.classList.contains("part")||(set_view("part"),"participant"in n&&(r=n.participant)),e){var i=decodeURIComponent(e.substr(1)),a=people.filter(function(e){return e.id==i});if(!a.length)return window.location.hash="#part",void 0;r="p"+a[0].id,t=find_name_range(a[0].sortname)}else if(r)return window.location.hash="#part/"+r.substr(1),void 0;if(!t){var o=EL("name_range");o&&(t=o.getElementsByTagName("li")[0].getAttribute("data-range"))}update_part_view(t,r)}function show_info_view(){set_view("info"),EL("prog_ls").innerHTML=""}function init_view(){var e=window.location.hash.substr(1);switch(e.length<4&&(e=storage_get("view")),e||(e="prog"),e.substr(0,4)){case"next":show_next_view();break;case"star":show_star_view(e.substr(4));break;case"part":show_part_view(e.substr(4));break;case"info":show_info_view();break;case"prog":show_prog_view();break;default:show_prog_view()}EL("load_disable")&&(EL("load_disable").style.display="none")}String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof document||"classList"in document.createElement("a")||!function(e){"use strict";var t="classList",r="prototype",n=(e.HTMLElement||e.Element)[r],i=Object,a=String[r].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[r].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1},s=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},l=function(e,t){if(""===t)throw new s("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new s("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(e,t)},c=function(e){for(var t=a.call(e.className),r=t?t.split(/\s+/):[],n=0,i=r.length;i>n;n++)this.push(r[n]);this._updateClassName=function(){e.className=this.toString()}},d=c[r]=[],p=function(){return new c(this)};if(s[r]=Error[r],d.item=function(e){return this[e]||null},d.contains=function(e){return e+="",-1!==l(this,e)},d.add=function(e){e+="",-1===l(this,e)&&(this.push(e),this._updateClassName())},d.remove=function(e){e+="";var t=l(this,e);-1!==t&&(this.splice(t,1),this._updateClassName())},d.toggle=function(e){e+="",-1===l(this,e)?this.add(e):this.remove(e)},d.toString=function(){return this.join(" ")},i.defineProperty){var _={get:p,enumerable:!0,configurable:!0};try{i.defineProperty(n,t,_)}catch(u){-2146823252===u.number&&(_.enumerable=!1,i.defineProperty(n,t,_))}}else i[r].__defineGetter__&&n.__defineGetter__(t,p)}(self),Server.prototype.disconnect=function(){this.connected=!1,this.el&&(this.el.innerHTML='<div id="server_info">Not connected</div>')},Server.prototype.logout=function(e){_log("server logout"),server.exec("/logout"),(e||window.event).preventDefault()},Server.prototype.error=function(e,t,r){if(_log("server error "+e+", url: "+t,"error"),r=r||this,""==e){var n=t.replace(r.host,"").replace("/"+r.id+"/","");e='The command "<code>'+n+'</code>" failed.'}if(!r.err_el){var i=document.createElement("div");i.id=r.err_el_id,i.title="Click to close",i.onclick=function(){r.err_el.style.display="none"},document.body.appendChild(i),r.err_el=i}return r.err_el.innerHTML="<div>Server error: <b>"+e+"</b></div>",r.err_el.style.display="block",!0},Server.prototype.onmessage=function(e,t){return e=e||window.event,e.origin!=t.host?(_log("Got an unexpected message from "+e.origin,"error"),_log(e),void 0):(JSON.parse(e.data,function(e,r){switch(e){case"ok":t.cb_ok(r,t);break;case"fail":t.error("",r,t)}}),void 0)},Server.prototype.prog_mtime=function(){var e=this.prog_server_mtime;for(var t in this.prog_data)this.prog_data[t][1]>e&&(e=this.prog_data[t][1]);return e},Server.prototype.add_prog=function(e,t){e instanceof Array&&(e=e.join(",")),_log('server add_prog "'+e+'" '+(t?"1":"0")),this.exec("prog"+(t?"?add=":"?rm=")+e+"&t="+this.prog_mtime())},Server.prototype.set_prog=function(e){_log('server set_prog "'+e),this.exec("prog?set="+e.join(",")+"&t="+this.prog_mtime())},Server.prototype.show_my_vote=function(e,t,r){if(t=t||document.getElementById("v"+e)){"undefined"==typeof r&&(r=this.my_votes_data[e]);for(var n=t.firstElementChild;null!=n;n=n.nextElementSibling)if(n.classList.contains("v_pos"))switch(r){case 2:n.classList.add("voted"),n.classList.add("v2"),n.title="doubleplusgood";break;case 1:n.classList.add("voted"),n.classList.remove("v2"),n.title="good";break;default:n.classList.remove("voted"),n.classList.remove("v2"),n.title="good"}else _set_class(n,"voted",0>r)}},Server.prototype.vote=function(e,t,r){if(r=r||this,r.pub_data){var n=r.my_votes_data[e];n&&--r.pub_data[e][0>n?0:n]}switch(r.my_votes_data[e]){case-1:0>t&&(t=0);break;case 1:t>0&&(t=2);break;case 2:t>0&&(t=0)}_log("server vote "+e+" "+t),r.my_votes_data[e]=t,t&&r.pub_data&&(e in r.pub_data||(r.pub_data[e]=[0,0,0,0]),++r.pub_data[e][0>t?0:t]),r.show_pub_votes(e),r.show_my_vote(e,null,t),r.vote_timers[e]&&window.clearTimeout(r.vote_timers[e]),r.vote_timers[e]=window.setTimeout(function(){r.exec("vote?v="+t+"&id="+e+"&t="+r.my_votes_mtime)},1e3)},Server.prototype.vote_click=function(e,t){e=e||window.event;var r=!1,n=0;switch(e.target.classList[0]){case"v_pos":n=1;break;case"v_neg":n=-1}if(n){var i=e.target.parentNode;i.parentNode.parentNode.classList.contains("expanded")?t.vote(i.id.substr(1),n,t):r=!0}r||(e.cancelBubble=!0,e.preventDefault(),e.stopPropagation())},Server.prototype.show_pub_votes=function(e,t){if(t=t||document.getElementById("v"+e)){var r=this.pub_data[e];if(!r)return t.classList.remove("has_votes"),void 0;_set_class(t,"has_votes",r[0]||r[1]||r[2]);for(var n=t.firstElementChild;null!=n;n=n.nextElementSibling)n.textContent=n.classList.contains("v_pos")?"+"+(r[1]+2*r[2]):"-"+r[0];var i=t.nextSibling;if(i&&i.classList.contains("num-comments"))i.textContent=r[3]+(1==r[3]?" comment":" comments");else if(r[3]){var a=_new_elem("div","num-comments",r[3]+(1==r[3]?" comment":" comments"));t.parentNode.insertBefore(a,i)}}},Server.prototype.decorate_list=function(e){for(var t=e.getElementsByClassName("votes"),r=0,n=t.length;n>r;++r){var i=t[r].id.substr(1);this.show_pub_votes(i,t[r]),i in this.my_votes_data&&this.show_my_vote(i,t[r])}},Server.prototype.onclick_show_comments=function(e,t,r,n,i,a){e=e||window.event,e.cancelBubble=!0,e.preventDefault(),e.stopPropagation();var o=e.target;switch(o.textContent.substr(0,4)){case"Show":r.style.display="block","none"==i.style.display&&(n.style.display="block"),a.show_comments(t,a);break;case"Hide":var s=a.pub_data[t],l=s&&s[3]>0?s[3]:0;o.textContent="Show "+l+" comment"+(1==l?"":"s"),o.style.display=l?"block":"none",r.style.display="none",n.style.display=l?"none":"block",i.style.display="none"}},Server.prototype.onclick_show_comment_form=function(e,t,r,n){e=e||window.event,e.cancelBubble=!0,e.preventDefault(),e.stopPropagation();var i=e.target;i.style.display="none",n.show_comment_form(t,i,r,n)},Server.prototype.make_comment_div=function(e){var t=_new_elem("div","comment"),r=_new_elem("span","comment-author",e.name);t.appendChild(r);var n=new Date(1e3*e.ctime),i=_new_elem("span","comment-time",pretty_date(n)+" at "+pretty_time(n,!1));i.title=n.toString(),t.appendChild(i);var a=_new_elem("div","",e.text);return t.appendChild(a),t},Server.prototype.show_comments=function(e,t){t=t||this;var r=document.getElementById("c"+e);if(r){var n=r.previousSibling;for(n&&"a"!=n.tagName.toLowerCase()&&(n=!1);r.firstChild;)r.removeChild(r.firstChild);var i=t.pub_comments[e];if("undefined"==typeof i)return n&&(n.classList.remove("js-link"),n.textContent="Loading comments..."),t.exec("comments?id="+e),void 0;var a=0;if(i)for(var o in i)++a,r.appendChild(t.make_comment_div(i[o]));if(t.pub_data&&(t.pub_data[e]?t.pub_data[e][3]=a:t.pub_data[e]=[0,0,0,a]),n&&(n.textContent="Hide comments",n.classList.add("js-link"),n.style.display=a?"block":"none"),!a){var s=document.getElementById("f"+e);if(s&&"none"==s.style.display){var l=s.previousSibling;l&&"a"==l.tagName.toLowerCase()&&(l.style.display="block")}}}},Server.prototype.show_comment_form=function(e,t,r,n){if(r.classList.contains("empty")){if(!document.getElementById("post_comment_iframe")){var i=document.createElement("iframe");i.id=i.name="post_comment_iframe",i.src="javascript:false",i.style.display="none",document.body.appendChild(i),window.onmessage=function(e){n.onmessage(e,n)}}r.method="post",r.action=n.url("add_comment?id="+encodeURIComponent(e)),r.target="post_comment_iframe",r.innerHTML='<textarea name="text" rows="4" placeholder="'+n.connected[0]+' posted..."></textarea><input type="submit" name="submit"><input type="reset" value="Cancel"><label><input type="checkbox" name="anon"> Post anonymously</label><label><input type="checkbox" name="hide"> Hide from public</label>',r.onclick=function(e){e=e||window.event,e.cancelBubble=!0,e.stopPropagation()},r.onsubmit=function(){r.submit.value="Posting...",r.submit.disabled=!0,r.anon.checked&&(r.action+="&anon=1",r.anon.disabled=!0),r.hide.checked&&(r.action+="&hide=1",r.hide.disabled=!0)},r.onreset=function(){t.style.display="block",r.style.display="none"},r.classList.remove("empty")}else r.submit.disabled=!1,r.anon.disabled=!1,r.hide.disabled=!1;r.submit.value="Post comment",r.style.display="block"},Server.prototype.make_comments_wrap=function(e){var t=_new_elem("a","js-link discreet"),r=_new_elem("div","comments");r.id="c"+e;var n=_new_elem("a","js-link discreet","Add a comment"),i=_new_elem("form","empty");i.id="f"+e;var a=this;t.onclick=function(t){a.onclick_show_comments(t,e,r,n,i,a)},n.onclick=function(t){a.onclick_show_comment_form(t,e,i,a)},i.style.display="none",t.textContent="Hide",t.click();var o=_new_elem("div","comments-wrap");return o.appendChild(t),o.appendChild(r),o.appendChild(n),o.appendChild(i),o},Server.prototype.show_extras=function(e,t){if(this.connected){var r=this;document.getElementById("c"+e)||t.appendChild(r.make_comments_wrap(e));var n="v"+e,i=document.getElementById(n);i&&(i.onclick=function(e){r.vote_click(e,r)}),this.show_my_vote(e,i)}},Server.prototype.show_ical_link=function(e){var t="";if(this.connected?this.ical&&(t="string"==typeof this.ical?'Your selection is available as an iCal (.ics) calendar at:<br><a href="'+this.ical+'">'+this.ical+'</a><br><span class="hint">Note that changes you make in this guide may take some time to show in your external calendar software.</span>':'To make your selection viewable in your calendar app, you may also <a id="ical_link" class="js-link">make it available</a> in iCal (.ics) calendar format'):t="For other export options, please login.",e)e.innerHTML+='<p id="ical_text">'+t;else{var r=document.getElementById("ical_text");r&&(r.innerHTML=t)}var n=document.getElementById("ical_link");if(n){var i=this;n.onclick=function(){i.exec("ical_link")}}},Server.prototype.url=function(e){return this.host+("/"==e[0]?"":"/"+this.id+"/")+e},Server.prototype.exec=function(e){if(/^(prog|vote)/.test(e)&&!this.connected)return _log("server not connected: "+e,"warn"),void 0;var t=document.createElement("script"),r=!1,n=this.url(e),i=this;t.src=n,t.async=!0,t.onerror=function(e){i.error("",(e||window.event).target.src,i)},t.onload=t.onreadystatechange=function(){r||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(r=!0,t.onload=t.onreadystatechange=null,t&&t.parentNode&&t.parentNode.removeChild(t))},document.getElementsByTagName("head")[0].appendChild(t)},Server.prototype.cb_ok=function(e,t){t=t||this;var r=/^(?:https?:\/\/[^\/]+)?\/?([^?\/]*)(?:\/([^?]*))(?:\?(.*))?/.exec(e),n=r[2]||"",i=r[3]||"";switch(n){case"logout":t.disconnect(),t.prog_data={},t.prog_server_mtime=0,t.my_votes_data={},t.my_votes_mtime=0,t.stars&&(t.stars.data={},t.stars.write(),init_view()),t.exec("info"),_log("server ok (logout): "+JSON.stringify(e));
break;case"prog":var a=/&server_mtime=(\d+)/.exec(i);a&&(t.prog_server_mtime=parseInt(a[1],10)),_log("server ok (prog): "+JSON.stringify(e));break;case"vote":var a=/&server_mtime=(\d+)/.exec(i);a&&(t.my_votes_mtime=parseInt(a[1],10)),_log("server ok (vote): "+JSON.stringify(e));break;case"add_comment":var o=/\bid=([^&]+)/.exec(i);if(o){t.exec("comments?id="+o[1]);var s=document.getElementById("f"+o[1]);s&&s.reset()}_log("server ok (add_comment): "+JSON.stringify(e));break;default:_log("server ok (???): "+JSON.stringify(e),"warn")}},Server.prototype.cb_fail=function(e){this.error(e.msg,e.url,this)},Server.prototype.cb_info=function(e){_log("server info: "+JSON.stringify(e)),this.connected=[e.name,e.email];var t=e.name==e.email?e.email:e.name+" &lt;"+e.email+"&gt;",r='<div id="server_info"><span id="server_user">'+t+"</span>";e.ical&&(this.ical=this.ical||!0,this.show_ical_link(!1)),r+='<a id="server_logout" href="'+this.url(e.logout)+'">Logout</a>',this.el.innerHTML=r,document.getElementById("server_logout").onclick=this.logout},Server.prototype.cb_login=function(e){_log("server login: "+JSON.stringify(e));var t=[];for(var r in e)t.push('<a href="'+this.url(r)+'">'+e[r]+"</a>");this.el.innerHTML='<div id="login-links" class="popup-wrap">\n&raquo; <span>Login to sync your data</span>\n<div id="login-disable-bg" class="popup-bg"></div><div class="popup">Once you\'ve verified your e-mail address, you\'ll be able to sync your data between different browsers and devices.\n<ul>\n<li>'+t.join("\n<li>")+"\n</ul></div></div>",make_popup_menu("login-links","login-disable-bg")},Server.prototype.cb_my_prog=function(e){if(_log("server my_prog: "+JSON.stringify(e)),this.prog_data=e.prog,e.t0)for(var t in this.prog_data)this.prog_data[t][1]+=e.t0;this.stars?this.stars.sync(this.prog_data):_log("Server.stars required for prog sync","warn")},Server.prototype.cb_my_votes=function(e){_log("server my_votes: "+JSON.stringify(e)),this.my_votes_data=e.votes,this.my_votes_mtime=e.mtime;for(var t in e.votes)this.show_my_vote(t)},Server.prototype.cb_pub_data=function(e){_log("server pub_data: "+JSON.stringify(e)),this.pub_data=e;for(var t in e)this.show_pub_votes(t)},Server.prototype.cb_show_comments=function(e,t){_log("server show_comments ("+e+"): "+JSON.stringify(t)),t.sort(function(e,t){return e.ctime-t.ctime}),this.pub_comments[e]=t,this.show_comments(e,this)},Server.prototype.cb_ical_link=function(e){this.ical=e,localStorage.setItem("konopas."+this.id+".ical_link",e),this.show_ical_link(!1)},Stars.prototype.read=function(){return JSON.parse(this.store.getItem(this.name)||"{}")},Stars.prototype.write=function(){try{this.store.setItem(this.name,JSON.stringify(this.data))}catch(e){if(e.code!=DOMException.QUOTA_EXCEEDED_ERR||0!=this.store.length)throw e}},Stars.prototype.list=function(){var e=[];if(this.data)for(var t in this.data)2==this.data[t].length&&this.data[t][0]&&e.push(t);return e},Stars.prototype.add=function(e,t){t=t||Math.floor(Date.now()/1e3),e.forEach(function(e){this.data[e]=[1,t]},this),this.write(),this.server&&this.server.set_prog(this.list())},Stars.prototype.set=function(e){var t=Math.floor(Date.now()/1e3);if(this.data)for(var r in this.data)this.data[r]=[0,t];this.add(e,t)},Stars.prototype.toggle=function(e,t){var r=!e.classList.contains(this.tag),n=Math.floor(Date.now()/1e3);this.data[t]=[r?1:0,n],this.write(),this.server&&this.server.add_prog(t,r),r?e.classList.add(this.tag):e.classList.remove(this.tag)},Stars.prototype.sync=function(e){var t=[],r=!1;for(var n in e)2==e[n].length?(!(n in this.data)||e[n][1]>this.data[n][1])&&(t.push(n),n in this.data&&e[n][0]==this.data[n][0]||(r=!0),this.data[n]=e[n]):_log("Stars.sync: invalid input "+n+": "+JSON.stringify(e[n]),"warn");if(t.length&&(_log("Stars.sync: local changes: "+t+(r?" -> redraw":"")),this.write(),r&&init_view()),this.server){var i=[],a=[];for(var n in this.data)(!(n in e)||e[n][1]<this.data[n][1])&&(this.data[n][0]?i.push(n):a.push(n));i.length&&(_log("Stars.sync: server add: "+i),this.server.add_prog(i,!0)),a.length&&(_log("Stars.sync: server rm: "+a),this.server.add_prog(a,!1)),t.length||i.length||a.length||_log("Stars.sync: no changes")}};var ko={id:"",full_version:!navigator.userAgent.match(/Android [12]/),default_duration:60,time_show_am_pm:!1,abbrev_00_minutes:!0,always_show_participants:!1,expand_all_max_items:100,show_all_days_by_default:!1,use_server:!1,log_messages:!0};if("object"==typeof konopas_set)for(var i in konopas_set)ko[i]=konopas_set[i];ko.id||alert("No ID set! Please assign konopas_set.id a unique identifier."),Array.prototype.indexOf&&Array.prototype.filter&&Array.prototype.map&&Date.now&&"localStorage"in window||alert("Unfortunately, your browser doesn't support some of the Javascript features required by KonOpas. To use, please try a different browser.");var stars=new Stars(ko.id),server=ko.use_server&&new Server(ko.id,stars),private_browsing_noted=!1,views=["next","star","prog","part","info"];if(function(){var e=_new_elem("div","item_frame"),t=e.appendChild(_new_elem("div","item_star")),r=e.appendChild(_new_elem("div","item")),n=r.appendChild(_new_elem("div","title")),i=r.appendChild(_new_elem("div","loc")),a=ko.use_server?r.appendChild(_new_elem("div","votes")):{id:""};ko.use_server&&(a.appendChild(_new_elem("a","v_pos","+0")).title="good",a.appendChild(document.createTextNode(" / ")),a.appendChild(_new_elem("a","v_neg","-0")).title="not so good"),this._item_el=function(o){return t.id="s"+o.id,r.id="p"+o.id,n.textContent=o.title,i.textContent=_item_loc_str(o),a.id="v"+o.id,e.cloneNode(!0)}}(),EL("prog_ls").onclick=item_list_click,EL("next_filters"))for(var ul=EL("next_filters").getElementsByTagName("li"),i=0,l=ul.length;l>i;++i)ul[i].onclick=function(){return next_filter(this.parentNode.id,this.id),!0};var pf=EL("prog_filters");pf.onclick=prog_filter_change;var sf=EL("search");sf&&(sf.onsubmit=prog_filter_change,EL("q").onblur=prog_filter_change,sf.onreset=function(){_prog_set_filters({})});for(var pl=pf.getElementsByClassName("popup-wrap"),i=0;i<pl.length;++i)make_popup_menu(pl[i]);if("undefined"!=typeof people){for(var i=0,l=people.length;l>i;++i)people[i].sortname=((people[i].name[1]||"")+"  "+people[i].name[0]).toLowerCase().replace(/^ +/,"");people.sort(function(e,t){return e.sortname<t.sortname?-1:e.sortname>t.sortname?1:0});for(var pc=EL("part_filters").getElementsByTagName("li"),i=0,l=pc.length;l>i;++i)pc[i].onclick=function(){return part_filter(this.parentNode.id,this),!0}}if(EL("scroll_link")){EL("scroll_link").onclick=function(){return EL("top").scrollIntoView(),!1};var prev_scroll={i:0,top:0},n=0;ko.full_version?window.onscroll=function(){var e=document.documentElement.scrollTop;EL("scroll").style.display=e>0?"block":"none",e+=20;var t=EL("time");if(t){var r=document.getElementsByClassName("new_time");if(r.length)if(e<r[0].offsetTop)prev_scroll.i=0,prev_scroll.top=r[0].offsetTop,t.style.display="none";else{var n=prev_scroll.top?prev_scroll.i:1;if(n>=r.length&&(n=r.length-1),e>r[n].offsetTop){for(;n<r.length&&e>r[n].offsetTop;)++n;--n}else for(;n>=0&&e<r[n].offsetTop;)--n;0>n&&(n=0),prev_scroll.i=n,prev_scroll.top=r[n].offsetTop,t.textContent=r[n].getAttribute("data-day")+"\n"+r[n].textContent,t.style.display="block"}}}:(EL("time").style.display="none",EL("scroll").style.display="none")}var lu=EL("last-updated"),cache_manifest=document.body.parentNode.getAttribute("manifest");if(lu&&cache_manifest&&"http:"==location.protocol){var x=new XMLHttpRequest;x.onload=function(){var e=new Date(this.getResponseHeader("Last-Modified")),t=lu.getElementsByTagName("span")[0];t.textContent=pretty_time_diff(e),t.title=e.toLocaleString(),t.onclick=function(e){var t=(e||window.event).target,r=t.title;t.title=t.textContent,t.textContent=r},lu.style.display="inline"},x.open("GET",cache_manifest,!0),x.send()}for(var pb=document.getElementsByClassName("popup-boxify"),i=0,l=pb.length;l>i;++i)popup_boxify(pb[i]);init_view(),window.onhashchange=init_view,EL("refresh")&&window.addEventListener("load",function(){var e=window.applicationCache;e.addEventListener("updateready",function(){e.status==e.UPDATEREADY&&(EL("refresh").classList.add("enabled"),EL("refresh").onclick=function(){window.location.reload()})},!1),e.status!=e.UNCACHED&&window.setInterval(function(){e.update()},36e4)},!1);