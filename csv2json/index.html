<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CSV2JSON</title>

<body>
<h1>CSV to JSON converter</h1>
<p>Input should be a CSV formatted file, with field names on the first row. Result will be a JSON array of objects.
<p>Uses FileReader, FileSaver and Blob interface from the HTML5 File API, so may not work on all browsers.

<p>
<input type="file" id="file">
<span id="info"></span><br>
<input type="submit" class="save" id="save-json" value="Save as JSON" disabled><br>
<input type="submit" class="save" id="save-js" value="Save as JavaScript" disabled><span id="js-wrap"></span>
<hr />
<pre id="result" style="white-space: pre-wrap;"></pre>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="jquery.csv-0.71.min.js"></script>
<script src="FileSaver.min.js"></script>
<script>

var json_data = "";
var filename = "";

function parse_sub_arrays(data) {
	for (var i in data) {
		for (var j in data[i]) {
			var n = j.match(/^([^.]+)\.(\d+)(\.([^.]+))?$/);
			if (n) {
				if (data[i][j] !== "") {
					if (!Array.isArray(data[i][n[1]])) data[i][n[1]] = new Array();
					var a = data[i][n[1]];
					if (n[4]) {
						if (typeof a[n[2]] != 'object') a[n[2]] = new Object();
						a[n[2]][n[4]] = data[i][j];
					} else {
						a[n[2]] = data[i][j];
					}
				}
				delete data[i][j];
			}
		}
	}
}

var reader = new FileReader();
reader.onload = function(event) {
    var data = $.csv.toObjects(event.target.result);
    parse_sub_arrays(data);
    json_data = JSON.stringify(data);
    if (json_data) {
		$('#result').html(json_data.replace(/</g, '&lt;')/*.replace(/{/g, "\n{")*/);
		$('.save').removeAttr("disabled");
		$('#js-wrap').html(' <tt>var<input type="text" id="js-var" value="' + filename + '"> = <i>JSON</i>;</tt>');
	} else {
		$('#result').html("JSON is empty!");
		$('.save').attr("disabled", true);
		$('#js-wrap').html("");
	}
};

reader.onerror = function(event) {
    $('#result').html("File could not be read! Code " + event.target.error.code);
};

$('#file').on("change", function() {
	if ($(this)[0].files.length) {
		var f = $(this)[0].files[0];
		$('#info').html("Type: " + f.type + ", Size: " + f.size + " bytes");
		filename = f.name.replace(/\.[^.]*$/, "");
		if (!filename) filename = "data";
		reader.readAsText(f);
	}
});

$('#save-json').click(function() {
	var blob = new Blob([json_data], {type: "application/json;charset=utf-8"});
	saveAs(blob, filename + '.json');
});

$('#save-js').click(function() {
	var txt = 'var ' + $('#js-var').val() + ' = ' + json_data + ';'
	var blob = new Blob([txt], {type: "text/javascript;charset=utf-8"});
	saveAs(blob, filename + '.js');
});

</script>
